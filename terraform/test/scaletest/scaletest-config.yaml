# Coder Scale Test Configuration
# 
# This configuration file defines parameters for Coder's built-in scale testing
# utilities to validate capacity and performance requirements.
#
# Requirements validated:
# - 14.6: Pod workspace provisioning < 2 minutes
# - 14.7: EC2 workspace provisioning < 5 minutes
# - 14.9: P95 API response time < 500ms
# - 14.10: P99 API response time < 1 second
# - 14.11: Support 1000 simultaneous workspace provisioning operations
#
# Usage:
#   ./run-scaletest.sh --config scaletest-config.yaml --test create-workspaces
#   ./run-scaletest.sh --config scaletest-config.yaml --test dashboard
#   ./run-scaletest.sh --config scaletest-config.yaml --test workspace-traffic
#   ./run-scaletest.sh --config scaletest-config.yaml --test all

# Global settings
global:
  # Coder deployment URL (set via environment variable CODER_URL)
  coder_url: "${CODER_URL}"
  # API token (set via environment variable CODER_SESSION_TOKEN)
  coder_token: "${CODER_SESSION_TOKEN}"
  # Output directory for test results
  output_dir: "./scaletest-results"
  # Enable verbose logging
  verbose: true

# Test: create-workspaces
# Validates: Requirements 14.6, 14.7, 14.11
# Purpose: Test concurrent workspace provisioning capacity
create_workspaces:
  # Number of workspaces to create concurrently
  count: 1000
  
  # Template configurations for different workspace types
  templates:
    # Pod-based workspaces (target: < 2 min provisioning)
    pod_workspaces:
      template: "pod-swdev"
      count: 700
      # Concurrency level for parallel provisioning
      concurrency: 100
      # Maximum time to wait for workspace to be ready
      timeout: "5m"
      # Expected provisioning time (for validation)
      expected_p95: "2m"
      
    # EC2-based workspaces (target: < 5 min provisioning)
    ec2_workspaces:
      template: "ec2-datasci"
      count: 300
      concurrency: 50
      timeout: "10m"
      expected_p95: "5m"
  
  # Cleanup settings
  cleanup:
    # Delete workspaces after test
    enabled: true
    # Delay before cleanup (allows metrics collection)
    delay: "5m"
    # Parallel deletion
    concurrency: 50

  # Retry settings for transient failures
  retry:
    max_attempts: 3
    backoff: "30s"

# Test: dashboard
# Validates: Requirements 14.9, 14.10
# Purpose: Test API latency under load
dashboard:
  # Number of concurrent users simulating dashboard access
  concurrency: 50
  
  # Duration of the test
  duration: "5m"
  
  # Request rate per second (0 = unlimited)
  rate_limit: 0
  
  # API endpoints to test
  endpoints:
    - path: "/api/v2/users/me"
      weight: 30
    - path: "/api/v2/workspaces"
      weight: 25
    - path: "/api/v2/templates"
      weight: 20
    - path: "/api/v2/organizations"
      weight: 15
    - path: "/api/v2/buildinfo"
      weight: 10
  
  # Performance targets
  targets:
    # P95 latency target (milliseconds)
    p95_latency_ms: 500
    # P99 latency target (milliseconds)
    p99_latency_ms: 1000
    # Maximum error rate (percentage)
    max_error_rate: 1.0
  
  # Output format for results
  output:
    format: "json"
    include_histogram: true

# Test: workspace-traffic
# Validates: Network throughput and connection stability
# Purpose: Test workspace connectivity under load
workspace_traffic:
  # Number of workspaces to generate traffic on
  workspace_count: 100
  
  # Template to use for traffic test workspaces
  template: "pod-swdev"
  
  # Traffic generation settings
  traffic:
    # Bytes to send per tick
    bytes_per_tick: 1024
    # Interval between ticks
    tick_interval: "100ms"
    # Duration of traffic generation
    duration: "10m"
  
  # Connection settings
  connection:
    # Use DERP relay (vs direct P2P)
    force_derp: false
    # Connection timeout
    timeout: "30s"
  
  # Performance targets
  targets:
    # Minimum throughput (bytes/second)
    min_throughput_bps: 10240
    # Maximum connection latency (milliseconds)
    max_latency_ms: 200
    # Maximum packet loss (percentage)
    max_packet_loss: 1.0

# Pre-test validation
pre_test:
  # Verify Coder API is accessible
  check_api: true
  # Verify templates exist
  check_templates: true
  # Verify sufficient quota
  check_quota: true
  # Minimum available workspace quota
  min_workspace_quota: 1100

# Post-test reporting
reporting:
  # Generate summary report
  summary: true
  # Generate detailed metrics
  detailed_metrics: true
  # Export to CloudWatch
  cloudwatch:
    enabled: true
    namespace: "Coder/ScaleTest"
    dimensions:
      Environment: "pre-production"
  # Export to file
  file:
    enabled: true
    format: "json"
    path: "./scaletest-results/report.json"
