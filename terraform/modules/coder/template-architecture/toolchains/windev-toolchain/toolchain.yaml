# Windows Development Toolchain Template
# Version: 1.0.0
#
# This is a portable toolchain template that declares what a Windows development
# workspace should contain (languages, tools, dependencies, capabilities) without
# specifying how it runs.
#
# Requirements Covered:
# - 11.4: Windows development toolchain template
# - 11c.2: Toolchain template declares capabilities without infrastructure details
# - 11c.3: Toolchain manifest declaring tools, versions, and capability requirements
# - 11c.4: Define capabilities (compute profile, network egress, persistent home)

name: windev-toolchain
version: "1.0.0"
description: |
  Windows development workspace toolchain for .NET and Windows application development.
  Includes Visual Studio 2022, .NET 8, and common Windows development tools.
  Suitable for C#, .NET, and Windows-native application development.

# ============================================================================
# TOOLCHAIN DEFINITION
# Languages, tools, and libraries included in this toolchain
# ============================================================================
toolchain:
  languages:
    - name: csharp
      version: "12"
      description: "C# programming language via .NET SDK"
      
    - name: dotnet
      version: "8"
      description: ".NET 8 SDK for cross-platform development"
      
    - name: powershell
      version: "7"
      description: "PowerShell Core for scripting and automation"

  tools:
    - name: visual-studio-2022
      version: "2022"
      edition: "Professional"
      description: "Visual Studio 2022 IDE"
      workloads:
        - Microsoft.VisualStudio.Workload.NetWeb
        - Microsoft.VisualStudio.Workload.Azure
        - Microsoft.VisualStudio.Workload.ManagedDesktop
      
    - name: git
      version: "latest"
      description: "Git for Windows"
      
    - name: azure-cli
      version: "latest"
      description: "Azure Command Line Interface"
      
    - name: powershell-core
      version: "7"
      description: "PowerShell 7 (cross-platform)"

    - name: nuget
      version: "latest"
      description: "NuGet package manager"

    - name: dotnet-cli
      version: "8"
      description: ".NET CLI tools"

  # Optional tools that can be enabled via configuration
  optional_tools:
    - name: sql-server-management-studio
      version: "latest"
      description: "SQL Server Management Studio"
      
    - name: azure-data-studio
      version: "latest"
      description: "Azure Data Studio"
      
    - name: postman
      version: "latest"
      description: "API development and testing"

    - name: docker-desktop
      version: "latest"
      description: "Docker Desktop for Windows"

# ============================================================================
# CAPABILITY REQUIREMENTS
# Capabilities this toolchain requires from infrastructure base modules
# ============================================================================
capabilities:
  required:
    - persistent-home    # Persist user profile data across restarts
    - gui-rdp            # RDP desktop for Visual Studio GUI

  optional: []

  # Network egress policy
  network_egress: https-only

  # Identity mode preference (infrastructure base may override)
  identity_mode: iam

  # Secrets injection preference
  secrets_injection: variables

# ============================================================================
# COMPUTE PROFILES
# T-shirt sizes available for this toolchain
# ============================================================================
compute_profiles:
  sw-dev-medium:
    cpu: 4
    memory: "8Gi"
    storage: "50Gi"
    gpu_count: 0
    description: "Standard Windows development"
    default: true
    
  sw-dev-large:
    cpu: 8
    memory: "16Gi"
    storage: "100Gi"
    gpu_count: 0
    description: "Heavy Windows development - large solutions"

# ============================================================================
# BOOTSTRAP CONFIGURATION
# Initialization scripts and environment setup
# ============================================================================
bootstrap:
  # PowerShell script to run on workspace start
  startup_script: |
    # Windows Development Workspace Bootstrap
    Write-Host "Initializing Windows development workspace..."
    
    # Ensure common directories exist
    $projectsDir = "$env:USERPROFILE\Projects"
    if (-not (Test-Path $projectsDir)) {
        New-Item -ItemType Directory -Path $projectsDir -Force | Out-Null
    }
    
    # Configure Git if not already configured
    $gitEmail = git config --global user.email 2>$null
    if (-not $gitEmail) {
        Write-Host "Git user.email not configured - will be set via Coder external auth"
    }
    
    # Verify Visual Studio installation
    $vsPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\Common7\IDE\devenv.exe"
    if (Test-Path $vsPath) {
        Write-Host "Visual Studio 2022 Professional: OK"
    } else {
        Write-Host "Visual Studio 2022: Not found at expected path"
    }
    
    # Verify .NET SDK
    $dotnetVersion = dotnet --version 2>$null
    if ($dotnetVersion) {
        Write-Host ".NET SDK: $dotnetVersion"
    }
    
    Write-Host "Windows development workspace ready!"

  # Environment variables to set
  environment:
    DOTNET_CLI_TELEMETRY_OPTOUT: "1"
    DOTNET_NOLOGO: "1"

# ============================================================================
# VALIDATION
# Tests to verify toolchain is correctly configured
# ============================================================================
validation:
  # Commands that must succeed for the toolchain to be considered valid
  health_checks:
    - name: dotnet_version
      command: "dotnet --version"
      expected_pattern: "8\\."
      
    - name: powershell_version
      command: "pwsh --version"
      expected_pattern: "PowerShell 7\\."
      
    - name: git_available
      command: "git --version"
      expected_pattern: "git version"
      
    - name: azure_cli_available
      command: "az --version"
      expected_pattern: "azure-cli"
      
    - name: nuget_available
      command: "nuget help"
      expected_pattern: "NuGet"

# ============================================================================
# METADATA
# Additional information about this toolchain
# ============================================================================
metadata:
  maintainer: "platform-team"
  license: "MIT"
  repository: "https://github.com/org/toolchain-templates"
  documentation: "https://docs.example.com/toolchains/windev"
  
  # Supported operating systems
  supported_os:
    - windows-server-2022
    
  # Tags for discovery
  tags:
    - windows-development
    - dotnet
    - csharp
    - visual-studio
    - azure
