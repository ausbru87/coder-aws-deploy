# Data Science Toolchain Template
# Version: 1.0.0
#
# This is a portable toolchain template that declares what a data science
# workspace should contain (languages, tools, libraries, capabilities) without
# specifying how it runs.
#
# Requirements Covered:
# - 11.4: Data science toolchain template
# - 11.9: GPU instance types and pre-installed ML tooling
# - 11c.2: Toolchain template declares capabilities without infrastructure details
# - 11c.3: Toolchain manifest declaring tools, versions, and capability requirements
# - 11c.4: Define capabilities (compute profile, network egress, persistent home)

name: datasci-toolchain
version: "1.0.0"
description: |
  Data science and machine learning workspace toolchain.
  Includes Python, R, Jupyter Lab, and popular ML frameworks.
  Supports optional GPU acceleration for training workloads.

# ============================================================================
# TOOLCHAIN DEFINITION
# Languages, tools, and libraries included in this toolchain
# ============================================================================
toolchain:
  languages:
    - name: python
      version: "3.12"
      description: "Python for data science and ML"
      package_manager: pip
      
    - name: r
      version: "4.x"
      description: "R for statistical computing"
      package_manager: CRAN

  tools:
    - name: jupyter-lab
      version: "latest"
      description: "JupyterLab for interactive notebooks"
      
    - name: cuda-toolkit
      version: "12.x"
      description: "NVIDIA CUDA toolkit for GPU computing"
      notes: "Only installed when GPU support is enabled"
      
    - name: git
      version: "latest"
      description: "Version control system"

    - name: dvc
      version: "latest"
      description: "Data Version Control for ML experiments"

    - name: mlflow
      version: "latest"
      description: "ML experiment tracking"

  libraries:
    python:
      # Deep Learning Frameworks
      - name: pytorch
        version: ">=2.0"
        description: "PyTorch deep learning framework"
        
      - name: tensorflow
        version: ">=2.15"
        description: "TensorFlow deep learning framework"
        
      # Data Science Essentials
      - name: scikit-learn
        version: ">=1.3"
        description: "Machine learning library"
        
      - name: pandas
        version: ">=2.0"
        description: "Data manipulation and analysis"
        
      - name: numpy
        version: ">=1.26"
        description: "Numerical computing"
        
      - name: scipy
        version: ">=1.11"
        description: "Scientific computing"
        
      # Visualization
      - name: matplotlib
        version: ">=3.8"
        description: "Plotting library"
        
      - name: seaborn
        version: ">=0.13"
        description: "Statistical visualization"
        
      - name: plotly
        version: ">=5.18"
        description: "Interactive visualizations"
        
      # Additional ML Tools
      - name: xgboost
        version: ">=2.0"
        description: "Gradient boosting"
        
      - name: lightgbm
        version: ">=4.0"
        description: "Light gradient boosting"
        
      - name: transformers
        version: ">=4.35"
        description: "Hugging Face transformers"

    r:
      - name: tidyverse
        description: "Data science packages"
        
      - name: ggplot2
        description: "Data visualization"
        
      - name: caret
        description: "Machine learning"
        
      - name: shiny
        description: "Interactive web apps"

  # Optional tools that can be enabled via configuration
  optional_tools:
    - name: vscode-jupyter
      description: "VS Code Jupyter extension"
      
    - name: tensorboard
      description: "TensorFlow visualization toolkit"
      
    - name: weights-and-biases
      description: "W&B experiment tracking"

    - name: ray
      description: "Distributed computing framework"

# ============================================================================
# CAPABILITY REQUIREMENTS
# Capabilities this toolchain requires from infrastructure base modules
# ============================================================================
capabilities:
  required:
    - persistent-home    # Persist /home/coder and datasets across restarts
    - outbound-https     # HTTPS egress for package downloads, model downloads

  optional:
    - gpu-support        # Optional GPU for ML training

  # Network egress policy
  network_egress: https-only

  # Identity mode preference (infrastructure base may override)
  identity_mode: iam

  # Secrets injection preference
  secrets_injection: variables

# ============================================================================
# COMPUTE PROFILES
# T-shirt sizes available for this toolchain
# ============================================================================
compute_profiles:
  datasci-standard:
    cpu: 8
    memory: "32Gi"
    storage: "500Gi"
    gpu_count: 0
    description: "Data analysis without GPU"
    default: true
    
  datasci-large:
    cpu: 16
    memory: "64Gi"
    storage: "1Ti"
    gpu_count: 1
    gpu_type: nvidia-t4
    description: "ML training with single GPU (T4)"
    
  datasci-xlarge:
    cpu: 32
    memory: "64Gi"
    storage: "2Ti"
    gpu_count: 4
    gpu_type: nvidia-a100
    description: "Large-scale ML with multiple GPUs (A100)"

# ============================================================================
# BOOTSTRAP CONFIGURATION
# Initialization scripts and environment setup
# ============================================================================
bootstrap:
  # Script to run on workspace start
  startup_script: |
    #!/bin/bash
    set -e
    
    echo "Initializing data science workspace..."
    
    # Ensure common directories exist
    mkdir -p ~/projects ~/data ~/models ~/notebooks ~/.jupyter
    
    # Configure Jupyter
    if [ ! -f ~/.jupyter/jupyter_lab_config.py ]; then
      jupyter lab --generate-config
    fi
    
    # Configure Git if not already configured
    if [ -z "$(git config --global user.email)" ]; then
      echo "Git user.email not configured - will be set via Coder external auth"
    fi
    
    # Verify GPU availability if requested
    if command -v nvidia-smi &> /dev/null; then
      echo "GPU Status:"
      nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv
    fi
    
    # Verify Python environment
    echo "Python: $(python3 --version)"
    echo "PyTorch: $(python3 -c 'import torch; print(torch.__version__)' 2>/dev/null || echo 'not installed')"
    echo "TensorFlow: $(python3 -c 'import tensorflow as tf; print(tf.__version__)' 2>/dev/null || echo 'not installed')"
    
    echo "Data science workspace ready!"

  # Environment variables to set
  environment:
    JUPYTER_ENABLE_LAB: "yes"
    PYTHONUNBUFFERED: "1"
    TF_CPP_MIN_LOG_LEVEL: "2"

# ============================================================================
# VALIDATION
# Tests to verify toolchain is correctly configured
# ============================================================================
validation:
  # Commands that must succeed for the toolchain to be considered valid
  health_checks:
    - name: python_version
      command: "python3 --version"
      expected_pattern: "Python 3\\.12"
      
    - name: jupyter_available
      command: "jupyter --version"
      expected_pattern: "jupyter"
      
    - name: pytorch_import
      command: "python3 -c 'import torch; print(torch.__version__)'"
      expected_pattern: "2\\."
      
    - name: tensorflow_import
      command: "python3 -c 'import tensorflow as tf; print(tf.__version__)'"
      expected_pattern: "2\\."
      
    - name: pandas_import
      command: "python3 -c 'import pandas; print(pandas.__version__)'"
      expected_pattern: "2\\."
      
    - name: sklearn_import
      command: "python3 -c 'import sklearn; print(sklearn.__version__)'"
      expected_pattern: "1\\."

  # GPU-specific checks (only run when GPU support enabled)
  gpu_checks:
    - name: nvidia_smi
      command: "nvidia-smi"
      expected_pattern: "NVIDIA-SMI"
      
    - name: cuda_available
      command: "python3 -c 'import torch; print(torch.cuda.is_available())'"
      expected_pattern: "True"

# ============================================================================
# METADATA
# Additional information about this toolchain
# ============================================================================
metadata:
  maintainer: "platform-team"
  license: "MIT"
  repository: "https://github.com/org/toolchain-templates"
  documentation: "https://docs.example.com/toolchains/datasci"
  
  # Supported operating systems
  supported_os:
    - amazon-linux-2023
    - ubuntu-22.04
    - ubuntu-24.04
    
  # Tags for discovery
  tags:
    - data-science
    - machine-learning
    - deep-learning
    - jupyter
    - python
    - pytorch
    - tensorflow
    - gpu
