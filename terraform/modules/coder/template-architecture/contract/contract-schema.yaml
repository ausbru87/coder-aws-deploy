# Template Contract Schema Definition
# This schema defines the stable interface between toolchain templates and infrastructure base modules.
# Version: 1.0
#
# Requirements Covered:
# - 11d.1: Define minimal, stable interface between toolchain and infrastructure layers
# - 11d.2: Specify toolchain template inputs (runtime type, compute profile, capabilities)
# - 11d.3: Specify infrastructure base outputs (agent_endpoint, env_vars, volume_mounts, metadata)
# - 11d.4: Specify infrastructure base inputs (workspace_name, owner, compute_profile, image_id)

contract:
  version: "1.0"
  description: |
    The template contract defines the interface between portable toolchain templates
    and instance-specific infrastructure base modules. This contract ensures:
    - Toolchain templates remain portable across Coder instances
    - Infrastructure bases can implement capabilities consistently
    - Composition is predictable and validatable

  # ============================================================================
  # CONTRACT INPUTS
  # These are the inputs that infrastructure base modules MUST accept
  # ============================================================================
  inputs:
    workspace_name:
      type: string
      required: true
      description: |
        The name of the workspace being provisioned.
        Typically sourced from data.coder_workspace.me.name

    owner:
      type: string
      required: true
      description: |
        The username of the workspace owner.
        Typically sourced from data.coder_workspace_owner.me.name

    compute_profile:
      type: object
      required: true
      description: |
        The compute resources requested for the workspace.
        Maps to t-shirt sizes defined in the toolchain template.
      properties:
        cpu:
          type: integer
          description: Number of vCPUs requested
          minimum: 1
          maximum: 64
        memory:
          type: string
          description: Memory allocation (e.g., "8Gi", "32Gi")
          pattern: "^[0-9]+[KMGT]i$"
        storage:
          type: string
          description: Storage allocation (e.g., "100Gi", "1Ti")
          pattern: "^[0-9]+[KMGT]i$"
        gpu_count:
          type: integer
          description: Number of GPUs requested (0 for none)
          minimum: 0
          maximum: 8
          default: 0
        gpu_type:
          type: string
          description: GPU type when gpu_count > 0
          enum:
            - nvidia-t4      # g4dn instances
            - nvidia-a10g    # g5 instances
            - nvidia-v100    # p3 instances
            - nvidia-a100    # p4d instances
          default: null

    image_id:
      type: string
      required: true
      description: |
        The toolchain image reference or identifier.
        Can be a container image digest, AMI ID, or artifact reference.
        Format depends on the infrastructure base module.

  # ============================================================================
  # CONTRACT OUTPUTS
  # These are the outputs that infrastructure base modules MUST provide
  # ============================================================================
  outputs:
    agent_endpoint:
      type: string
      required: true
      description: |
        The endpoint where the Coder agent can be reached.
        Used by coderd to establish agent connections.

    runtime_env:
      type: object
      required: true
      description: |
        Environment variables to inject into the workspace runtime.
        Keys are variable names, values are variable values.
      additionalProperties:
        type: string

    volume_mounts:
      type: array
      required: true
      description: |
        Volume mounts configured for the workspace.
        Used for persistent storage and shared data.
      items:
        type: object
        properties:
          path:
            type: string
            description: Mount path inside the workspace
          type:
            type: string
            description: Storage type
            enum:
              - pvc       # Kubernetes PersistentVolumeClaim
              - ebs       # AWS EBS volume
              - efs       # AWS EFS mount
              - local     # Local ephemeral storage
          size:
            type: string
            description: Volume size (e.g., "100Gi")
          storage_class:
            type: string
            description: Storage class or volume type (e.g., "gp3", "io2")

    metadata:
      type: object
      required: true
      description: |
        Additional metadata about the provisioned workspace.
        Used for tracking, auditing, and composition provenance.
      properties:
        platform:
          type: string
          description: Infrastructure platform type
          enum:
            - kubernetes
            - ec2-linux
            - ec2-windows
            - ec2-gpu
        os:
          type: string
          description: Operating system
          enum:
            - linux
            - windows
        arch:
          type: string
          description: CPU architecture
          enum:
            - amd64
            - arm64
        toolchain_version:
          type: string
          description: Version of the toolchain template used
        base_version:
          type: string
          description: Version of the infrastructure base module used
        image_digest:
          type: string
          description: Resolved image digest (for container images)
        ami_id:
          type: string
          description: Resolved AMI ID (for EC2 instances)
        provisioned_at:
          type: string
          format: date-time
          description: Timestamp when workspace was provisioned

